<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowSync 管理后台</title>
  <style>
    :root {
      --bg: #eff3f8;
      --card: #ffffff;
      --text: #1b2430;
      --muted: #5f6b7b;
      --line: #d7dde6;
      --line-soft: #e8edf4;
      --brand: #1e66ff;
      --brand-strong: #1452d8;
      --danger: #c9302c;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "PingFang SC", "Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(30, 102, 255, 0.1), transparent 35%),
        radial-gradient(circle at 100% 100%, rgba(22, 163, 74, 0.07), transparent 30%),
        var(--bg);
      color: var(--text);
    }
    .app-shell {
      max-width: 1320px;
      margin: 0 auto;
      padding: 24px;
    }
    h1, h2, h3 { margin: 0; }
    .headline { margin-bottom: 18px; }
    .subtle { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.7);
    }
    .value { font-size: 22px; font-weight: 700; margin-top: 4px; }
    .section { margin-bottom: 18px; }
    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0;
      background: var(--brand);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .15s ease;
      font-size: 14px;
    }
    .btn:hover { background: var(--brand-strong); }
    .btn.secondary { background: #4f5d75; }
    .btn.danger { background: var(--danger); }
    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--line-soft);
      border-radius: 10px;
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; min-width: 760px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--line-soft); font-size: 14px; }
    th { background: #f6f8fb; }
    .th-filter { position: relative; }
    .th-filter-head { display: inline-flex; align-items: center; gap: 6px; }
    .filter-trigger {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      border-radius: 999px;
      width: 20px;
      height: 20px;
      font-size: 12px;
      line-height: 18px;
      text-align: center;
      cursor: pointer;
      padding: 0;
    }
    .filter-popover {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9998;
      width: 180px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
    }
    .filter-popover.open { display: block; }
    .filter-popover input, .filter-popover select { font-size: 13px; padding: 7px 8px; }
    input, select, textarea {
      padding: 9px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      background: #fff;
      color: var(--text);
    }
    textarea { font-family: ui-monospace, Menlo, monospace; font-size: 12px; }
    .row { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .task-form { display: grid; gap: 12px; }
    .form-block {
      border: 1px solid var(--line-soft);
      border-radius: 10px;
      padding: 12px;
      background: linear-gradient(180deg, #fbfdff 0%, #fff 100%);
    }
    .form-block h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #344256;
      font-weight: 700;
    }
    .check-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 6px 10px;
    }
    .check-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }
    .check-item input[type="checkbox"] { width: 16px; height: 16px; }
    .param-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .param-field {
      border: 1px solid var(--line-soft);
      border-radius: 8px;
      background: #fff;
      padding: 10px;
    }
    .param-field label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: #2b3a4f;
      margin-bottom: 8px;
    }
    .param-field .hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .log-box {
      background: #111827;
      color: #d7fbd6;
      padding: 12px;
      border-radius: 8px;
      height: 220px;
      overflow: auto;
      font-family: ui-monospace, Menlo, monospace;
      font-size: 12px;
    }
    .task-row { cursor: pointer; position: relative; }
    .task-row.active { background: #eef4ff; }
    .status-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .status-running { color: #0b5bd3; background: #e7f0ff; }
    .status-success { color: #0f7a3d; background: #e8f8ef; }
    .status-failed { color: #b42318; background: #ffecec; }
    .status-idle, .status-paused { color: #475467; background: #eef1f5; }
    .progress-wrap {
      min-width: 180px;
      max-width: 240px;
    }
    .progress-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e9eef7;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1e66ff 0%, #2f8bff 100%);
      transition: width .18s ease;
    }
    .progress-text {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .actions-cell { position: relative; }
    .action-trigger { min-width: 76px; }
    .action-menu {
      position: fixed;
      left: 0;
      top: 0;
      z-index: 30;
      display: none;
      min-width: 140px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 8px;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.16);
      padding: 6px;
    }
    .action-menu.open { display: block; }
    .action-menu button {
      width: 100%;
      border: 0;
      background: transparent;
      color: var(--text);
      text-align: left;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .action-menu button:hover { background: #edf3ff; }
    .action-menu button.danger { color: #b42318; }
    .action-menu hr {
      border: 0;
      border-top: 1px solid var(--line-soft);
      margin: 6px 0;
    }
    .action-menu-top { z-index: 9999; }
    .hidden { display: none; }
    .modal-backdrop.hidden { display: none; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(12, 18, 32, 0.45);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      animation: fadeIn .12s ease-out;
    }
    .modal {
      width: min(960px, 100%);
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      animation: popIn .12s ease-out;
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .modal-open { overflow: hidden; }
    .guard-note {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #fff6e8;
      border: 1px solid #f5d0a0;
      color: #7a4b00;
      font-size: 13px;
    }
    .guard-note.error {
      background: #ffecec;
      border-color: #f7b7b7;
      color: #8f1f1f;
    }
    .auth-modal {
      width: min(520px, 100%);
    }
    .auth-help {
      margin: 6px 0 10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }
    .auth-error {
      min-height: 20px;
      margin-top: 8px;
      color: #b42318;
      font-size: 13px;
    }
    .auth-cooldown {
      min-height: 18px;
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }
    .auth-actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .toast-wrap {
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 10010;
      display: grid;
      gap: 8px;
      max-width: min(420px, calc(100vw - 28px));
    }
    .toast {
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.18);
      font-size: 13px;
      line-height: 1.45;
    }
    .toast.error {
      border-color: #f2b8b8;
      background: #fff3f3;
      color: #8f1f1f;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="headline">
      <h1>FlowSync Web 管理后台</h1>
      <div class="subtle">任务管理、Remotes 配置与运行审计</div>
      <div class="guard-note" id="adminGuardStatus">只读访问已开启。查看敏感配置及高危写操作需要管理员安全密码。</div>
      <div class="subtle" id="syncStatus" aria-live="polite">连接状态：初始化中</div>
    </div>

    <div class="section">
      <h2 style="margin-bottom:12px;">仪表盘</h2>
      <div class="grid">
        <div class="card"><div>运行中任务</div><div class="value" id="runningTasks">0</div></div>
        <div class="card"><div>今日传输流量</div><div class="value" id="todayBytes">0 B</div></div>
        <div class="card"><div>今日执行次数</div><div class="value" id="todayRuns">0</div></div>
        <div class="card"><div>CPU / 内存</div><div class="value" id="systemUsage">0% / 0 B</div></div>
      </div>
    </div>

    <div class="section card">
      <div class="section-head">
        <h2>后端存储配置（Remotes）</h2>
        <button class="btn" id="openRemoteModalBtn" type="button">新建 / 编辑 Remote</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>名称</th><th>类型</th><th>关键信息</th><th>操作</th></tr>
          </thead>
          <tbody id="remotesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <div class="section-head">
        <h2>任务列表</h2>
        <button class="btn" id="openTaskModalBtn" type="button">创建任务</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th class="th-filter">
                <span class="th-filter-head">名称 <button class="filter-trigger" id="taskNameFilterBtn" type="button">▾</button></span>
                <div class="filter-popover" id="taskNamePopover">
                  <input id="taskNameFilter" list="taskNameOptions" placeholder="名称关键词（留空=全部）" aria-label="按任务名称筛选" />
                  <datalist id="taskNameOptions"></datalist>
                </div>
              </th>
              <th class="th-filter">
                <span class="th-filter-head">模式 <button class="filter-trigger" id="taskModeFilterBtn" type="button">▾</button></span>
                <div class="filter-popover" id="taskModePopover">
                  <select id="taskModeFilter" aria-label="按任务模式筛选">
                    <option value="">模式: 全部</option>
                    <option value="copy">copy</option>
                    <option value="sync">sync</option>
                    <option value="move">move</option>
                  </select>
                </div>
              </th>
              <th>源</th><th>目标</th><th>Cron</th><th>启用</th>
              <th class="th-filter">
                <span class="th-filter-head">状态 <button class="filter-trigger" id="taskStatusFilterBtn" type="button">▾</button></span>
                <div class="filter-popover" id="taskStatusPopover">
                  <select id="taskStatusFilter" aria-label="按任务状态筛选">
                    <option value="">状态: 全部</option>
                    <option value="running">running</option>
                    <option value="success">success</option>
                    <option value="failed">failed</option>
                    <option value="idle">idle</option>
                    <option value="paused">paused</option>
                  </select>
                </div>
              </th>
              <th>进度</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2 style="margin-bottom:8px;">任务实时事件</h2>
      <div class="subtle" id="taskEventHint">请先点击上方任务行查看该任务实时事件</div>
      <div style="margin:8px 0;">
        <input id="eventsKeyword" placeholder="搜索实时事件关键词（如文件名）" aria-label="搜索实时事件关键词" />
      </div>
      <div class="log-box" id="events" role="log" aria-live="polite" aria-atomic="false"></div>
    </div>

    <div class="section">
      <div class="section-head">
        <h2>审计日志</h2>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Run ID</th>
              <th class="th-filter">
                <span class="th-filter-head">Task ID <button class="filter-trigger" id="runsTaskIdFilterBtn" type="button">▾</button></span>
                <div class="filter-popover" id="runsTaskIdPopover">
                  <input id="runsTaskIdFilter" placeholder="全部" aria-label="按 Task ID 筛选审计日志" />
                </div>
              </th>
              <th class="th-filter">
                <span class="th-filter-head">状态 <button class="filter-trigger" id="runsStatusFilterBtn" type="button">▾</button></span>
                <div class="filter-popover" id="runsStatusPopover">
                  <select id="runsStatusFilter" aria-label="按状态筛选审计日志">
                    <option value="">状态: 全部</option>
                    <option value="running">running</option>
                    <option value="success">success</option>
                    <option value="failed">failed</option>
                  </select>
                </div>
              </th>
              <th>触发方式</th><th>开始</th><th>结束</th><th>成功文件</th><th>失败文件</th><th>传输字节</th>
            </tr>
          </thead>
          <tbody id="runsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="action-menu action-menu-top" id="taskActionMenu">
    <button id="taskActionRun" type="button">立即运行</button>
    <button id="taskActionEdit" type="button">编辑</button>
    <button id="taskActionDuplicate" type="button">复制</button>
    <button id="taskActionToggle" type="button">暂停</button>
    <hr />
    <button class="danger" id="taskActionDelete" type="button">删除</button>
  </div>
  <div class="action-menu action-menu-top" id="remoteActionMenu">
    <button id="remoteActionEdit" type="button">编辑</button>
    <button id="remoteActionDuplicate" type="button">复制</button>
    <hr />
    <button class="danger" id="remoteActionDelete" type="button">删除</button>
  </div>

  <div id="remoteModalBackdrop" class="modal-backdrop hidden">
    <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="remoteModalTitle">
      <div class="modal-head">
        <h2 id="remoteModalTitle">配置 Remote</h2>
        <button class="btn secondary" id="closeRemoteModalBtn" type="button">关闭</button>
      </div>
      <form id="remoteForm">
        <div class="row">
          <input id="remoteName" placeholder="remote 名称（如 local / s3prod）" aria-label="Remote 名称" required />
          <select id="remoteType" aria-label="Remote 类型">
            <option value="fs">fs</option>
            <option value="s3">s3</option>
            <option value="sftp">sftp</option>
            <option value="ftp">ftp</option>
          </select>
        </div>
        <div class="row" style="margin-top:10px;">
          <textarea id="remoteConfigJson" rows="7" placeholder='config_json（JSON对象，不含type字段）
示例(fs): {"root": "/"}
示例(s3): {"bucket":"my-bucket","endpoint":"https://s3.us-east-1.amazonaws.com","region":"us-east-1","url_style":"path","root":""}' aria-label="Remote 配置 JSON" required></textarea>
        </div>
        <div style="margin-top:12px;">
          <button class="btn" type="submit">保存 Remote</button>
        </div>
      </form>
    </div>
  </div>

  <div id="taskModalBackdrop" class="modal-backdrop hidden">
    <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
      <div class="modal-head">
        <h2 id="taskModalTitle">创建任务</h2>
        <button class="btn secondary" id="closeTaskModalBtn" type="button">关闭</button>
      </div>
      <form id="taskForm" class="task-form">
        <input id="taskId" type="hidden" />
        <div class="form-block">
          <h3>基础信息</h3>
          <div class="row">
            <input id="name" placeholder="任务名称" aria-label="任务名称" required />
            <select id="mode" aria-label="任务模式">
              <option value="sync">sync</option>
              <option value="copy">copy</option>
              <option value="move">move</option>
            </select>
            <input id="cron" placeholder="Cron (可选，如 0 */10 * * * *)" aria-label="Cron 表达式" />
          </div>
        </div>
        <div class="form-block">
          <h3>数据路径</h3>
          <div class="row">
            <input id="source" placeholder="source (如 local:/data/src)" aria-label="源路径" required />
            <input id="destination" placeholder="destination (如 s3prod:bucket/prefix)" aria-label="目标路径" required />
          </div>
        </div>
        <div class="form-block">
          <h3>执行参数</h3>
          <div class="param-grid">
            <div class="param-field">
              <label for="transfers">并发传输数</label>
              <input id="transfers" type="number" min="1" value="4" placeholder="默认 4" />
              <div class="hint">同时执行文件传输的数量。值越大速度可能越快，但更占用带宽和 CPU。</div>
            </div>
            <div class="param-field">
              <label for="checkers">并发检查数</label>
              <input id="checkers" type="number" min="1" value="8" placeholder="默认 8" />
              <div class="hint">同时执行源/目标扫描与差异比对的数量。值越大前期扫描更快。</div>
            </div>
            <div class="param-field">
              <label for="bandwidth">带宽限制</label>
              <input id="bandwidth" placeholder="可选，如 100MB" />
              <div class="hint">为空表示不限速；设置后可降低对业务网络的影响。</div>
            </div>
            <div class="param-field">
              <label for="chunkSize">流式分块大小</label>
              <input id="chunkSize" placeholder="默认 8MB（如 8MB / 16MB / 32MB）" />
              <div class="hint">单文件按块读写与哈希，减小内存峰值。S3 场景建议从 8MB 起步。</div>
            </div>
          </div>
          <div class="check-row" style="margin-top:10px;">
            <label class="check-item"><input id="checksum" type="checkbox" /> checksum</label>
            <label class="check-item"><input id="ignoreExisting" type="checkbox" /> ignore-existing</label>
            <label class="check-item"><input id="dryRun" type="checkbox" /> dry-run</label>
            <label class="check-item"><input id="enabled" type="checkbox" checked /> 启用调度</label>
          </div>
        </div>
        <div>
          <button class="btn" type="submit">创建任务</button>
        </div>
      </form>
    </div>
  </div>

  <div id="adminAuthBackdrop" class="modal-backdrop hidden">
    <div class="modal card auth-modal" role="dialog" aria-modal="true" aria-labelledby="adminAuthTitle">
      <div class="modal-head">
        <h2 id="adminAuthTitle">管理员安全验证</h2>
      </div>
      <div class="auth-help" id="adminAuthPrompt">执行此操作前，请输入管理员安全密码。</div>
      <input id="adminAuthInput" type="password" placeholder="管理员安全密码" aria-label="管理员安全密码" autocomplete="off" />
      <div class="auth-error" id="adminAuthError"></div>
      <div class="auth-cooldown" id="adminAuthCooldown"></div>
      <div class="auth-actions">
        <button class="btn secondary" id="adminAuthCancelBtn" type="button">取消</button>
        <button class="btn danger" id="adminAuthConfirmBtn" type="button">确认执行</button>
      </div>
    </div>
  </div>
  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <script>
    const byId = (id) => document.getElementById(id);
    const fmtBytes = (n) => {
      const units = ['B','KB','MB','GB','TB']; let i = 0; let x = Number(n || 0);
      while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
      return `${x.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    };
    const fmtDateTime = (value) => {
      if (!value) return '';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return String(value);
      return d.toLocaleString('zh-CN', { hour12: false });
    };
    const eventBox = byId('events');
    const taskEventHint = byId('taskEventHint');
    const adminGuardStatus = byId('adminGuardStatus');
    const syncStatus = byId('syncStatus');
    const toastWrap = byId('toastWrap');
    const remoteModalBackdrop = byId('remoteModalBackdrop');
    const taskModalBackdrop = byId('taskModalBackdrop');
    const adminAuthBackdrop = byId('adminAuthBackdrop');
    const taskNameFilter = byId('taskNameFilter');
    const taskModeFilter = byId('taskModeFilter');
    const taskStatusFilter = byId('taskStatusFilter');
    const runsTaskIdFilter = byId('runsTaskIdFilter');
    const runsStatusFilter = byId('runsStatusFilter');
    const eventsKeyword = byId('eventsKeyword');
    const adminAuthInput = byId('adminAuthInput');
    const adminAuthPrompt = byId('adminAuthPrompt');
    const adminAuthError = byId('adminAuthError');
    const adminAuthCooldown = byId('adminAuthCooldown');
    const adminAuthCancelBtn = byId('adminAuthCancelBtn');
    const adminAuthConfirmBtn = byId('adminAuthConfirmBtn');
    const taskActionMenu = byId('taskActionMenu');
    const remoteActionMenu = byId('remoteActionMenu');
    const taskNameFilterBtn = byId('taskNameFilterBtn');
    const taskModeFilterBtn = byId('taskModeFilterBtn');
    const taskStatusFilterBtn = byId('taskStatusFilterBtn');
    const runsTaskIdFilterBtn = byId('runsTaskIdFilterBtn');
    const runsStatusFilterBtn = byId('runsStatusFilterBtn');
    const ADMIN_AUTH_TTL_MS = 15 * 60 * 1000;
    const ADMIN_AUTH_COOLDOWN_MS = 3 * 1000;
    const MAX_TASK_EVENT_LINES = 2000;
    const adminPassword = (() => {
      const fromWindow = window.__FLOWSYNC_UI_CONFIG__?.adminPassword;
      if (typeof fromWindow === 'string' && fromWindow.trim()) return fromWindow;
      try {
        const fromLocalStorage = localStorage.getItem('flowsync_admin_password');
        if (typeof fromLocalStorage === 'string' && fromLocalStorage.trim()) return fromLocalStorage;
      } catch (_) {
      }
      return '';
    })();
    let adminAuthorizedUntil = 0;
    let adminAuthFailUntil = 0;
    let adminAuthResolver = null;
    let adminAuthPromise = null;
    let adminCooldownTimer = null;
    let selectedTaskId = null;
    let selectedTaskName = '';
    let activeActionTaskId = null;
    let activeActionRemoteName = null;
    let editingTaskId = null;
    let latestTasks = [];
    let latestRemotes = [];
    let latestRuns = [];
    const taskProgressMap = new Map();
    let loadingTaskEventsFor = null;
    let taskEventLines = [];
    let eventsSearchTimer = null;
    let wsConnected = false;
    let taskRenderTimer = null;
    let runsRefreshInterval = null;
    let tasksRefreshInterval = null;
    let dashboardRefreshInterval = null;
    let modalFocusReturnEl = null;

    function setSyncStatus(message) {
      if (syncStatus) syncStatus.textContent = `连接状态：${message}`;
    }

    function showToast(message, isError = false) {
      if (!toastWrap) return;
      const el = document.createElement('div');
      el.className = `toast${isError ? ' error' : ''}`;
      el.textContent = message;
      toastWrap.appendChild(el);
      setTimeout(() => {
        el.remove();
      }, isError ? 5000 : 2800);
    }

    function displayError(context, err) {
      const msg = String(err && err.message ? err.message : err || 'unknown error');
      showToast(`${context}: ${msg}`, true);
      console.error(context, err);
    }

    window.addEventListener('error', (event) => {
      displayError('页面运行异常', event.error || event.message);
    });
    window.addEventListener('unhandledrejection', (event) => {
      displayError('请求失败', event.reason);
    });

    function setGuardStatus(message, isError = false) {
      if (!adminGuardStatus) return;
      adminGuardStatus.textContent = message;
      adminGuardStatus.classList.toggle('error', Boolean(isError));
    }

    function updateAdminCooldownHint() {
      const remainMs = Math.max(0, adminAuthFailUntil - Date.now());
      const remainSec = Math.ceil(remainMs / 1000);
      adminAuthConfirmBtn.disabled = remainMs > 0;
      adminAuthCooldown.textContent = remainMs > 0 ? `冷却中，请 ${remainSec} 秒后再试。` : '';
      if (remainMs === 0 && adminCooldownTimer) {
        clearInterval(adminCooldownTimer);
        adminCooldownTimer = null;
      }
    }

    function closeAdminAuthModal(result) {
      closeModal(adminAuthBackdrop);
      if (adminCooldownTimer) {
        clearInterval(adminCooldownTimer);
        adminCooldownTimer = null;
      }
      const resolver = adminAuthResolver;
      adminAuthResolver = null;
      adminAuthPromise = null;
      if (resolver) resolver(result);
    }

    function openAdminAuthModal(actionLabel) {
      if (adminAuthPromise) return adminAuthPromise;
      if (!adminPassword) {
        alert('未配置管理员安全密码，已禁止高危操作。请联系管理员配置 window.__FLOWSYNC_UI_CONFIG__.adminPassword 或 localStorage: flowsync_admin_password');
        setGuardStatus('当前未配置管理员安全密码，高危写操作已禁用。', true);
        return Promise.resolve(false);
      }
      adminAuthPrompt.textContent = `即将执行：${actionLabel}。请输入管理员安全密码继续。`;
      adminAuthError.textContent = '';
      adminAuthCooldown.textContent = '';
      adminAuthInput.value = '';
      openModal(adminAuthBackdrop, '#adminAuthInput');
      updateAdminCooldownHint();
      if (!adminCooldownTimer) {
        adminCooldownTimer = setInterval(updateAdminCooldownHint, 250);
      }
      adminAuthPromise = new Promise((resolve) => {
        adminAuthResolver = resolve;
      });
      return adminAuthPromise;
    }

    async function guardedAction(actionLabel, actionFn) {
      const ok = await ensureAdminVerified(actionLabel);
      if (!ok) return false;
      await actionFn();
      const remainMin = Math.max(0, Math.ceil((adminAuthorizedUntil - Date.now()) / 60000));
      setGuardStatus(`管理员验证有效（剩余约 ${remainMin} 分钟）。高危操作将继续受门禁控制。`);
      return true;
    }

    async function ensureAdminVerified(actionLabel) {
      if (Date.now() >= adminAuthorizedUntil) {
        const ok = await openAdminAuthModal(actionLabel);
        if (!ok) return false;
      }
      return true;
    }

    function closeAllFilterPopovers() {
      document.querySelectorAll('.filter-popover.open').forEach((el) => el.classList.remove('open'));
    }
    function toggleFilterPopover(popoverId, event) {
      event?.stopPropagation();
      const popover = byId(popoverId);
      if (!popover) return;
      const shouldOpen = !popover.classList.contains('open');
      closeAllFilterPopovers();
      if (!shouldOpen) return;
      popover.classList.add('open');
      const trigger = event?.currentTarget || event?.target;
      const rect = trigger?.getBoundingClientRect?.();
      if (!rect) return;
      const popoverWidth = popover.offsetWidth || 180;
      const popoverHeight = popover.offsetHeight || 120;
      let left = rect.left;
      let top = rect.bottom + 6;
      left = Math.max(8, Math.min(left, window.innerWidth - popoverWidth - 8));
      if (top + popoverHeight > window.innerHeight - 8) {
        top = Math.max(8, rect.top - popoverHeight - 6);
      }
      popover.style.left = `${left}px`;
      popover.style.top = `${top}px`;
    }
    function closeAllTaskActionMenus() {
      taskActionMenu.classList.remove('open');
      activeActionTaskId = null;
    }
    function closeAllRemoteActionMenus() {
      remoteActionMenu.classList.remove('open');
      activeActionRemoteName = null;
    }
    function toggleTaskActionMenu(taskId, event) {
      event?.stopPropagation();
      const task = latestTasks.find((t) => t.id === taskId);
      if (!task) return;
      const wasSameTaskOpen = taskActionMenu.classList.contains('open') && activeActionTaskId === taskId;
      closeAllTaskActionMenus();
      closeAllRemoteActionMenus();
      if (wasSameTaskOpen) return;
      activeActionTaskId = taskId;
      byId('taskActionToggle').textContent = task.enabled ? '暂停' : '恢复';
      taskActionMenu.classList.add('open');
      const trigger = event?.currentTarget || event?.target;
      const rect = trigger?.getBoundingClientRect?.();
      if (!rect) return;
      const menuWidth = taskActionMenu.offsetWidth || 150;
      const menuHeight = taskActionMenu.offsetHeight || 180;
      let left = rect.right - menuWidth;
      let top = rect.bottom + 6;
      left = Math.max(8, Math.min(left, window.innerWidth - menuWidth - 8));
      if (top + menuHeight > window.innerHeight - 8) {
        top = Math.max(8, rect.top - menuHeight - 6);
      }
      taskActionMenu.style.left = `${left}px`;
      taskActionMenu.style.top = `${top}px`;
    }
    function toggleRemoteActionMenu(name, event) {
      event?.stopPropagation();
      const remote = latestRemotes.find((r) => r.name === name);
      if (!remote) return;
      const wasSameRemoteOpen = remoteActionMenu.classList.contains('open') && activeActionRemoteName === name;
      closeAllRemoteActionMenus();
      closeAllTaskActionMenus();
      if (wasSameRemoteOpen) return;
      activeActionRemoteName = name;
      remoteActionMenu.classList.add('open');
      const trigger = event?.currentTarget || event?.target;
      const rect = trigger?.getBoundingClientRect?.();
      if (!rect) return;
      const menuWidth = remoteActionMenu.offsetWidth || 150;
      const menuHeight = remoteActionMenu.offsetHeight || 140;
      let left = rect.right - menuWidth;
      let top = rect.bottom + 6;
      left = Math.max(8, Math.min(left, window.innerWidth - menuWidth - 8));
      if (top + menuHeight > window.innerHeight - 8) {
        top = Math.max(8, rect.top - menuHeight - 6);
      }
      remoteActionMenu.style.left = `${left}px`;
      remoteActionMenu.style.top = `${top}px`;
    }

    async function api(path, init) {
      const res = await fetch(path, init);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `HTTP ${res.status}`);
      }
      if (res.status === 204) return null;
      return res.json();
    }

    function statusLabel(status, enabled) {
      if (!enabled) return 'paused';
      return status || 'idle';
    }

    function statusClass(status) {
      if (status === 'running') return 'status-running';
      if (status === 'success') return 'status-success';
      if (status === 'failed') return 'status-failed';
      if (status === 'paused') return 'status-paused';
      return 'status-idle';
    }

    function updateTaskEventHint() {
      if (selectedTaskId == null) {
        taskEventHint.textContent = '请先点击上方任务行查看该任务实时事件';
      } else {
        taskEventHint.textContent = `当前任务: #${selectedTaskId} ${selectedTaskName}`;
      }
    }

    function renderTaskEvents() {
      const isNearBottom = eventBox.scrollHeight - eventBox.scrollTop - eventBox.clientHeight < 18;
      const keyword = (eventsKeyword.value || '').trim().toLowerCase();
      const lines = keyword
        ? taskEventLines.filter((line) => line.toLowerCase().includes(keyword))
        : taskEventLines;
      eventBox.textContent = lines.join('\n');
      if (lines.length > 0) eventBox.textContent += '\n';
      if (isNearBottom) eventBox.scrollTop = eventBox.scrollHeight;
    }

    function normalizeEventPayloadForDisplay(obj) {
      if (!obj || typeof obj !== 'object') return obj;
      const out = { ...obj };
      if (out.at) out.at = fmtDateTime(out.at);
      if (out.created_at) out.created_at = fmtDateTime(out.created_at);
      return out;
    }

    function appendTaskEvent(obj) {
      if (selectedTaskId == null) return;
      const ts = obj?.at || obj?.created_at || Date.now();
      const displayPayload = normalizeEventPayloadForDisplay(obj);
      const line = `[${fmtDateTime(ts)}] ${JSON.stringify(displayPayload)}`;
      taskEventLines.push(line);
      if (taskEventLines.length > MAX_TASK_EVENT_LINES) {
        taskEventLines.splice(0, taskEventLines.length - MAX_TASK_EVENT_LINES);
      }
      renderTaskEvents();
    }

    async function loadTaskEventHistory(taskId) {
      loadingTaskEventsFor = taskId;
      const keyword = (eventsKeyword.value || '').trim();
      const query = keyword
        ? `/api/events?task_id=${taskId}&limit=2000&keyword=${encodeURIComponent(keyword)}`
        : `/api/events?task_id=${taskId}&limit=2000`;
      const events = await api(query);
      if (loadingTaskEventsFor !== taskId || selectedTaskId !== taskId) return;
      taskEventLines = [];
      for (const record of events) {
        const payload = normalizeEventPayloadForDisplay(record.payload || { event: record.event_type });
        const line = `[${fmtDateTime(record.created_at || Date.now())}] ${JSON.stringify(payload)}`;
        taskEventLines.push(line);
      }
      renderTaskEvents();
    }

    function selectTask(id, name) {
      if (selectedTaskId !== id) {
        taskEventLines = [];
        renderTaskEvents();
      }
      selectedTaskId = id;
      selectedTaskName = name;
      updateTaskEventHint();
      document.querySelectorAll('#tasksBody tr').forEach((tr) => {
        tr.classList.toggle('active', Number(tr.dataset.taskId) === id);
      });
      loadTaskEventHistory(id).catch((e) => {
        taskEventLines = [`[${fmtDateTime(Date.now())}] 加载历史事件失败: ${String(e)}`];
        renderTaskEvents();
      });
    }

    function getFilteredTasks() {
      const nameKeyword = (taskNameFilter.value || '').trim().toLowerCase();
      const mode = taskModeFilter.value;
      const status = taskStatusFilter.value;
      return latestTasks.filter((t) => {
        const effectiveStatus = statusLabel(t.status, t.enabled);
        if (nameKeyword && !String(t.name || '').toLowerCase().includes(nameKeyword)) return false;
        if (mode && t.mode !== mode) return false;
        if (status && effectiveStatus !== status) return false;
        return true;
      });
    }

    function textCell(value) {
      const td = document.createElement('td');
      td.textContent = value == null ? '' : String(value);
      return td;
    }

    function applyTaskStatusCell(td, task) {
      const effective = statusLabel(task.status, task.enabled);
      const span = document.createElement('span');
      span.className = `status-pill ${statusClass(effective)}`;
      span.textContent = effective;
      td.textContent = '';
      td.appendChild(span);
    }

    function applyTaskProgressCell(td, task) {
      td.textContent = '';
      td.appendChild(renderTaskProgressCell(task));
    }

    function renderTasks(tasks) {
      const tbody = byId('tasksBody');
      tbody.textContent = '';
      const frag = document.createDocumentFragment();
      for (const t of tasks) {
        const tr = document.createElement('tr');
        tr.className = `task-row${selectedTaskId === t.id ? ' active' : ''}`;
        tr.dataset.taskId = String(t.id);
        tr.addEventListener('click', () => selectTask(t.id, t.name));

        tr.appendChild(textCell(t.id));
        tr.appendChild(textCell(t.name));
        tr.appendChild(textCell(t.mode));
        tr.appendChild(textCell(t.source));
        tr.appendChild(textCell(t.destination));
        tr.appendChild(textCell(t.cron_expr || ''));
        tr.appendChild(textCell(t.enabled ? '是' : '否'));

        const statusTd = document.createElement('td');
        statusTd.dataset.col = 'status';
        applyTaskStatusCell(statusTd, t);
        tr.appendChild(statusTd);

        const progressTd = document.createElement('td');
        progressTd.dataset.col = 'progress';
        applyTaskProgressCell(progressTd, t);
        tr.appendChild(progressTd);

        const actionsTd = document.createElement('td');
        actionsTd.className = 'actions-cell';
        const actionBtn = document.createElement('button');
        actionBtn.className = 'btn secondary action-trigger';
        actionBtn.type = 'button';
        actionBtn.textContent = '操作 ▾';
        actionBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleTaskActionMenu(t.id, event);
        });
        actionsTd.appendChild(actionBtn);
        tr.appendChild(actionsTd);
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }

    function clampProgress(pct) {
      const n = Number(pct);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(100, n));
    }

    function setTaskProgress(taskId, patch) {
      const existing = taskProgressMap.get(taskId) || {};
      taskProgressMap.set(taskId, {
        ...existing,
        ...patch,
        updated_at: Date.now(),
      });
    }

    function getTaskProgressDisplay(task) {
      const effectiveStatus = statusLabel(task.status, task.enabled);
      const progress = taskProgressMap.get(task.id);
      if (effectiveStatus === 'paused') {
        return { pct: 0, text: '-' };
      }
      if (!progress) {
        if (effectiveStatus === 'running') return { pct: 0, text: '0.0%' };
        return { pct: 0, text: '-' };
      }
      const pct = clampProgress(progress.progress_pct);
      const completed = Number(progress.completed_bytes || 0);
      const total = Number(progress.total_bytes || 0);
      if (total > 0) {
        return { pct, text: `${pct.toFixed(1)}% (${fmtBytes(completed)} / ${fmtBytes(total)})` };
      }
      return { pct, text: `${pct.toFixed(1)}%` };
    }

    function renderTaskProgressCell(task) {
      const d = getTaskProgressDisplay(task);
      const wrap = document.createElement('div');
      wrap.className = 'progress-wrap';
      const track = document.createElement('div');
      track.className = 'progress-track';
      const fill = document.createElement('div');
      fill.className = 'progress-fill';
      fill.style.width = `${d.pct.toFixed(1)}%`;
      const text = document.createElement('div');
      text.className = 'progress-text';
      text.textContent = d.text;
      track.appendChild(fill);
      wrap.appendChild(track);
      wrap.appendChild(text);
      return wrap;
    }

    function updateTaskRowDisplay(taskId) {
      const row = document.querySelector(`#tasksBody tr[data-task-id="${taskId}"]`);
      if (!row) return;
      const task = latestTasks.find((t) => t.id === taskId);
      if (!task) return;
      const progressTd = row.querySelector('td[data-col="progress"]');
      const statusTd = row.querySelector('td[data-col="status"]');
      if (statusTd) applyTaskStatusCell(statusTd, task);
      if (progressTd) applyTaskProgressCell(progressTd, task);
    }

    function scheduleTaskRender(delayMs = 120) {
      if (taskRenderTimer) return;
      taskRenderTimer = setTimeout(() => {
        taskRenderTimer = null;
        renderTasks(getFilteredTasks());
      }, delayMs);
    }

    function summarizeRemoteConfig(remote) {
      const cfg = remote?.config_json || {};
      const type = String(remote?.type || '').toLowerCase();
      const parts = [];
      if (type === 's3') {
        if (cfg.endpoint) parts.push(`endpoint: ${cfg.endpoint}`);
        if (cfg.bucket) parts.push(`bucket: ${cfg.bucket}`);
        if (cfg.region) parts.push(`region: ${cfg.region}`);
        if (cfg.root) parts.push(`root: ${cfg.root}`);
      } else if (type === 'fs') {
        if (cfg.root) parts.push(`root: ${cfg.root}`);
      } else if (type === 'sftp' || type === 'ftp') {
        if (cfg.endpoint) parts.push(`endpoint: ${cfg.endpoint}`);
        if (cfg.host) parts.push(`host: ${cfg.host}`);
        if (cfg.port != null) parts.push(`port: ${cfg.port}`);
        if (cfg.user) parts.push(`user: ${cfg.user}`);
        if (cfg.root) parts.push(`root: ${cfg.root}`);
      }
      if (parts.length > 0) return parts.join(' | ');

      const hidden = new Set([
        'access_key',
        'secret_key',
        'session_token',
        'password',
        'passphrase',
        'token',
        'credential',
        'credentials',
      ]);
      const generic = Object.entries(cfg)
        .filter(([k, v]) => !hidden.has(String(k).toLowerCase()) && v !== null && v !== '')
        .slice(0, 3)
        .map(([k, v]) => `${k}: ${String(v)}`);
      if (generic.length > 0) return generic.join(' | ');
      return '未展示敏感配置，点击“操作 ▾ → 编辑”查看全部';
    }

    function renderRemotes(remotes) {
      const tbody = byId('remotesBody');
      tbody.textContent = '';
      const frag = document.createDocumentFragment();
      for (const r of remotes) {
        const tr = document.createElement('tr');
        tr.appendChild(textCell(r.name));
        tr.appendChild(textCell(r.type));
        const summaryTd = textCell(summarizeRemoteConfig(r));
        summaryTd.style.color = 'var(--muted)';
        tr.appendChild(summaryTd);
        const actionsTd = document.createElement('td');
        actionsTd.className = 'actions-cell';
        const actionBtn = document.createElement('button');
        actionBtn.className = 'btn secondary action-trigger';
        actionBtn.type = 'button';
        actionBtn.textContent = '操作 ▾';
        actionBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleRemoteActionMenu(r.name, event);
        });
        actionsTd.appendChild(actionBtn);
        tr.appendChild(actionsTd);
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }

    function getFilteredRuns() {
      const taskIdRaw = runsTaskIdFilter.value.trim();
      const status = runsStatusFilter.value;
      return latestRuns.filter((r) => {
        if (taskIdRaw && String(r.task_id) !== taskIdRaw) return false;
        if (status && r.status !== status) return false;
        return true;
      });
    }

    function renderRuns(runs) {
      const tbody = byId('runsBody');
      tbody.textContent = '';
      const frag = document.createDocumentFragment();
      for (const r of runs) {
        const tr = document.createElement('tr');
        tr.appendChild(textCell(r.id));
        tr.appendChild(textCell(r.task_id));
        tr.appendChild(textCell(r.status));
        tr.appendChild(textCell(r.trigger_type));
        tr.appendChild(textCell(fmtDateTime(r.started_at)));
        tr.appendChild(textCell(fmtDateTime(r.ended_at)));
        tr.appendChild(textCell(r.copied_files));
        tr.appendChild(textCell(r.failed_files));
        tr.appendChild(textCell(fmtBytes(r.copied_bytes)));
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }

    function refreshTaskNameFilterOptions() {
      const optionsEl = byId('taskNameOptions');
      const names = Array.from(
        new Set((latestTasks || []).map((t) => String(t.name || '').trim()).filter(Boolean))
      ).sort((a, b) => a.localeCompare(b, 'zh-CN'));
      optionsEl.textContent = '';
      const frag = document.createDocumentFragment();
      for (const name of names) {
        const option = document.createElement('option');
        option.value = name;
        frag.appendChild(option);
      }
      optionsEl.appendChild(frag);
    }

    async function refreshTasks() {
      latestTasks = await api('/api/tasks');
      refreshTaskNameFilterOptions();
      renderTasks(getFilteredTasks());
    }

    async function refreshRemotes() {
      latestRemotes = await api('/api/remotes');
      renderRemotes(latestRemotes);
    }

    async function refreshRuns() {
      latestRuns = await api('/api/runs?limit=200');
      renderRuns(getFilteredRuns());
    }

    async function refreshDashboard() {
      const d = await api('/api/dashboard');
      byId('runningTasks').textContent = d.running_tasks;
      byId('todayBytes').textContent = fmtBytes(d.today_transferred_bytes);
      byId('todayRuns').textContent = d.today_runs;
      byId('systemUsage').textContent = `${(d.cpu_usage_percent || 0).toFixed(1)}% / ${fmtBytes(d.memory_used_bytes)} / ${fmtBytes(d.memory_total_bytes)}`;
    }

    async function runTask(id) {
      await api(`/api/tasks/${id}/run`, { method: 'POST' });
      await refreshDashboard();
    }
    async function pauseTask(id) {
      await api(`/api/tasks/${id}/pause`, { method: 'POST' });
      await refreshTasks();
    }
    async function resumeTask(id) {
      await api(`/api/tasks/${id}/resume`, { method: 'POST' });
      await refreshTasks();
    }
    async function deleteTask(id) {
      await api(`/api/tasks/${id}`, { method: 'DELETE' });
      if (selectedTaskId === id) {
        selectedTaskId = null;
        selectedTaskName = '';
        taskEventLines = [];
        renderTaskEvents();
        updateTaskEventHint();
      }
      await refreshTasks();
      await refreshRuns();
    }
    async function deleteRemote(name) {
      await api(`/api/remotes/${encodeURIComponent(name)}`, { method: 'DELETE' });
      await refreshRemotes();
    }
    function isAnyModalOpen() {
      return !remoteModalBackdrop.classList.contains('hidden')
        || !taskModalBackdrop.classList.contains('hidden')
        || !adminAuthBackdrop.classList.contains('hidden');
    }

    function openModal(backdrop, focusSelector) {
      if (!backdrop || !backdrop.classList.contains('hidden')) return;
      modalFocusReturnEl = document.activeElement;
      backdrop.classList.remove('hidden');
      document.body.classList.add('modal-open');
      const target = focusSelector ? backdrop.querySelector(focusSelector) : null;
      if (target) setTimeout(() => target.focus(), 0);
    }

    function closeModal(backdrop) {
      if (!backdrop || backdrop.classList.contains('hidden')) return;
      backdrop.classList.add('hidden');
      if (!isAnyModalOpen()) {
        document.body.classList.remove('modal-open');
        if (modalFocusReturnEl && typeof modalFocusReturnEl.focus === 'function') {
          modalFocusReturnEl.focus();
        }
      }
    }

    function trapModalFocus(backdrop, event) {
      if (backdrop.classList.contains('hidden') || event.key !== 'Tab') return;
      const modal = backdrop.querySelector('[role="dialog"]');
      if (!modal) return;
      const focusable = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    }

    function openRemoteModal() {
      openModal(remoteModalBackdrop, '#remoteName');
    }
    function closeRemoteModal() {
      closeModal(remoteModalBackdrop);
    }
    function openTaskModal() {
      openModal(taskModalBackdrop, '#name');
    }
    function closeTaskModal() {
      closeModal(taskModalBackdrop);
    }
    function fillRemoteForm(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      byId('remoteName').value = data.name;
      byId('remoteType').value = data.type;
      byId('remoteConfigJson').value = JSON.stringify(data.config_json || {}, null, 2);
      openRemoteModal();
    }
    function duplicateRemote(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      byId('remoteName').value = `${data.name}-copy`;
      byId('remoteType').value = data.type;
      byId('remoteConfigJson').value = JSON.stringify(data.config_json || {}, null, 2);
      openRemoteModal();
    }
    function fillTaskForm(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      editingTaskId = data.id;
      byId('taskId').value = String(data.id);
      byId('taskModalTitle').textContent = `编辑任务 #${data.id}`;
      byId('taskForm').querySelector('button[type="submit"]').textContent = '保存任务';
      byId('name').value = data.name || '';
      byId('source').value = data.source || '';
      byId('destination').value = data.destination || '';
      byId('mode').value = data.mode || 'sync';
      byId('cron').value = data.cron_expr || '';
      byId('enabled').checked = Boolean(data.enabled);
      byId('transfers').value = Number(data.transfers || 4);
      byId('checkers').value = Number(data.checkers || 8);
      byId('checksum').checked = Boolean(data.checksum);
      byId('ignoreExisting').checked = Boolean(data.ignore_existing);
      byId('dryRun').checked = Boolean(data.dry_run);
      byId('bandwidth').value = data.bandwidth_limit || '';
      byId('chunkSize').value = data.chunk_size || '8MB';
      openTaskModal();
    }
    function duplicateTask(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      resetTaskFormToCreateMode();
      byId('name').value = `${data.name}-copy`;
      byId('source').value = data.source || '';
      byId('destination').value = data.destination || '';
      byId('mode').value = data.mode || 'sync';
      byId('cron').value = data.cron_expr || '';
      byId('enabled').checked = Boolean(data.enabled);
      byId('transfers').value = Number(data.transfers || 4);
      byId('checkers').value = Number(data.checkers || 8);
      byId('checksum').checked = Boolean(data.checksum);
      byId('ignoreExisting').checked = Boolean(data.ignore_existing);
      byId('dryRun').checked = Boolean(data.dry_run);
      byId('bandwidth').value = data.bandwidth_limit || '';
      byId('chunkSize').value = data.chunk_size || '8MB';
      openTaskModal();
    }
    function resetTaskFormToCreateMode() {
      editingTaskId = null;
      byId('taskId').value = '';
      byId('taskModalTitle').textContent = '创建任务';
      byId('taskForm').querySelector('button[type="submit"]').textContent = '创建任务';
      byId('taskForm').reset();
      byId('transfers').value = 4;
      byId('checkers').value = 8;
      byId('chunkSize').value = '8MB';
      byId('enabled').checked = true;
    }
    window.runTask = runTask;
    window.pauseTask = pauseTask;
    window.resumeTask = resumeTask;
    window.deleteTask = deleteTask;
    window.fillTaskForm = fillTaskForm;
    window.duplicateTask = duplicateTask;
    window.selectTask = selectTask;
    window.deleteRemote = deleteRemote;
    window.fillRemoteForm = fillRemoteForm;
    window.duplicateRemote = duplicateRemote;
    window.openRemoteModal = openRemoteModal;
    window.closeRemoteModal = closeRemoteModal;
    window.openTaskModal = openTaskModal;
    window.closeTaskModal = closeTaskModal;
    window.toggleFilterPopover = toggleFilterPopover;
    window.toggleTaskActionMenu = toggleTaskActionMenu;
    window.closeAllTaskActionMenus = closeAllTaskActionMenus;
    window.toggleRemoteActionMenu = toggleRemoteActionMenu;
    window.closeAllRemoteActionMenus = closeAllRemoteActionMenus;

    taskActionMenu.addEventListener('click', (event) => event.stopPropagation());
    remoteActionMenu.addEventListener('click', (event) => event.stopPropagation());

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.th-filter')) closeAllFilterPopovers();
      if (!e.target.closest('.actions-cell')) closeAllTaskActionMenus();
      if (!e.target.closest('.actions-cell')) closeAllRemoteActionMenus();
    });
    document.addEventListener('keydown', (e) => {
      trapModalFocus(remoteModalBackdrop, e);
      trapModalFocus(taskModalBackdrop, e);
      trapModalFocus(adminAuthBackdrop, e);
      if (e.key !== 'Escape') return;
      if (!adminAuthBackdrop.classList.contains('hidden')) {
        e.preventDefault();
        closeAdminAuthModal(false);
        return;
      }
      if (!taskModalBackdrop.classList.contains('hidden')) {
        e.preventDefault();
        closeTaskModal();
        resetTaskFormToCreateMode();
        return;
      }
      if (!remoteModalBackdrop.classList.contains('hidden')) {
        e.preventDefault();
        closeRemoteModal();
      }
    });
    window.addEventListener('resize', () => {
      closeAllFilterPopovers();
      closeAllTaskActionMenus();
      closeAllRemoteActionMenus();
    });
    window.addEventListener('scroll', () => {
      closeAllFilterPopovers();
      closeAllTaskActionMenus();
      closeAllRemoteActionMenus();
    }, true);

    taskNameFilterBtn.addEventListener('click', (event) => toggleFilterPopover('taskNamePopover', event));
    taskModeFilterBtn.addEventListener('click', (event) => toggleFilterPopover('taskModePopover', event));
    taskStatusFilterBtn.addEventListener('click', (event) => toggleFilterPopover('taskStatusPopover', event));
    runsTaskIdFilterBtn.addEventListener('click', (event) => toggleFilterPopover('runsTaskIdPopover', event));
    runsStatusFilterBtn.addEventListener('click', (event) => toggleFilterPopover('runsStatusPopover', event));

    byId('openRemoteModalBtn').addEventListener('click', () => {
      byId('remoteForm').reset();
      openRemoteModal();
    });
    byId('taskActionRun').addEventListener('click', async () => {
      if (activeActionTaskId == null) return;
      const id = activeActionTaskId;
      closeAllTaskActionMenus();
      await guardedAction(`立即运行任务 #${id}`, async () => runTask(id));
    });
    byId('taskActionEdit').addEventListener('click', () => {
      if (activeActionTaskId == null) return;
      const task = latestTasks.find((t) => t.id === activeActionTaskId);
      closeAllTaskActionMenus();
      if (!task) return;
      fillTaskForm(encodeURIComponent(JSON.stringify(task)));
    });
    byId('taskActionDuplicate').addEventListener('click', () => {
      if (activeActionTaskId == null) return;
      const task = latestTasks.find((t) => t.id === activeActionTaskId);
      closeAllTaskActionMenus();
      if (!task) return;
      duplicateTask(encodeURIComponent(JSON.stringify(task)));
    });
    byId('taskActionToggle').addEventListener('click', async () => {
      if (activeActionTaskId == null) return;
      const task = latestTasks.find((t) => t.id === activeActionTaskId);
      const id = activeActionTaskId;
      closeAllTaskActionMenus();
      if (!task) return;
      if (task.enabled) {
        await guardedAction(`暂停任务 #${id}`, async () => pauseTask(id));
      } else {
        await guardedAction(`恢复任务 #${id}`, async () => resumeTask(id));
      }
    });
    byId('taskActionDelete').addEventListener('click', async () => {
      if (activeActionTaskId == null) return;
      const id = activeActionTaskId;
      closeAllTaskActionMenus();
      await guardedAction(`删除任务 #${id}`, async () => deleteTask(id));
    });
    byId('remoteActionEdit').addEventListener('click', async () => {
      if (activeActionRemoteName == null) return;
      const remote = latestRemotes.find((r) => r.name === activeActionRemoteName);
      closeAllRemoteActionMenus();
      if (!remote) return;
      const ok = await ensureAdminVerified(`查看 remote ${remote.name} 的敏感配置`);
      if (!ok) return;
      fillRemoteForm(encodeURIComponent(JSON.stringify({
        name: remote.name,
        type: remote.type,
        config_json: remote.config_json || {},
      })));
    });
    byId('remoteActionDuplicate').addEventListener('click', async () => {
      if (activeActionRemoteName == null) return;
      const remote = latestRemotes.find((r) => r.name === activeActionRemoteName);
      closeAllRemoteActionMenus();
      if (!remote) return;
      const ok = await ensureAdminVerified(`查看并复制 remote ${remote.name} 的敏感配置`);
      if (!ok) return;
      duplicateRemote(encodeURIComponent(JSON.stringify({
        name: remote.name,
        type: remote.type,
        config_json: remote.config_json || {},
      })));
    });
    byId('remoteActionDelete').addEventListener('click', async () => {
      if (activeActionRemoteName == null) return;
      const name = activeActionRemoteName;
      closeAllRemoteActionMenus();
      await guardedAction(`删除 remote ${name}`, async () => deleteRemote(name));
    });
    byId('closeRemoteModalBtn').addEventListener('click', closeRemoteModal);
    remoteModalBackdrop.addEventListener('click', (e) => {
      if (e.target === remoteModalBackdrop) closeRemoteModal();
    });
    byId('openTaskModalBtn').addEventListener('click', () => {
      resetTaskFormToCreateMode();
      openTaskModal();
    });
    byId('closeTaskModalBtn').addEventListener('click', () => {
      closeTaskModal();
      resetTaskFormToCreateMode();
    });
    taskModalBackdrop.addEventListener('click', (e) => {
      if (e.target === taskModalBackdrop) {
        closeTaskModal();
        resetTaskFormToCreateMode();
      }
    });

    byId('remoteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = byId('remoteName').value.trim();
      const type = byId('remoteType').value;
      let configJson = {};
      try {
        configJson = JSON.parse(byId('remoteConfigJson').value || '{}');
      } catch (err) {
        alert(`config_json 不是合法 JSON: ${err}`);
        return;
      }
      await guardedAction(`保存 remote ${name}`, async () => {
        try {
          await api(`/api/remotes/${encodeURIComponent(name)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, config_json: configJson }),
          });
        } catch (_) {
          await api('/api/remotes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, type, config_json: configJson }),
          });
        }
        await refreshRemotes();
        byId('source').placeholder = `${name}:/path/from`;
        byId('destination').placeholder = `${name}:/path/to`;
        closeRemoteModal();
      });
    });

    byId('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        name: byId('name').value,
        source: byId('source').value,
        destination: byId('destination').value,
        mode: byId('mode').value,
        cron_expr: byId('cron').value || null,
        enabled: byId('enabled').checked,
        transfers: Number(byId('transfers').value || 4),
        checkers: Number(byId('checkers').value || 8),
        checksum: byId('checksum').checked,
        ignore_existing: byId('ignoreExisting').checked,
        dry_run: byId('dryRun').checked,
        include: [],
        exclude: [],
        bandwidth_limit: byId('bandwidth').value || null,
        chunk_size: byId('chunkSize').value || '8MB'
      };
      const actionLabel = editingTaskId ? `修改任务 #${editingTaskId}` : `创建任务 ${payload.name || ''}`.trim();
      await guardedAction(actionLabel, async () => {
        if (editingTaskId) {
          await api(`/api/tasks/${editingTaskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          await api('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
        resetTaskFormToCreateMode();
        closeTaskModal();
        await refreshTasks();
        await refreshRuns();
      });
    });

    adminAuthCancelBtn.addEventListener('click', () => closeAdminAuthModal(false));
    adminAuthBackdrop.addEventListener('click', (e) => {
      if (e.target === adminAuthBackdrop) closeAdminAuthModal(false);
    });
    adminAuthInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeAdminAuthModal(false);
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        adminAuthConfirmBtn.click();
      }
    });
    adminAuthConfirmBtn.addEventListener('click', () => {
      if (!adminPassword) {
        setGuardStatus('当前未配置管理员安全密码，敏感配置查看与高危写操作已禁用。', true);
        adminAuthError.textContent = '未配置管理员安全密码。';
        return;
      }
      if (Date.now() < adminAuthFailUntil) {
        updateAdminCooldownHint();
        return;
      }
      if ((adminAuthInput.value || '') !== adminPassword) {
        adminAuthFailUntil = Date.now() + ADMIN_AUTH_COOLDOWN_MS;
        adminAuthError.textContent = '密码错误，请重试。';
        updateAdminCooldownHint();
        adminAuthInput.select();
        return;
      }
      adminAuthorizedUntil = Date.now() + ADMIN_AUTH_TTL_MS;
      closeAdminAuthModal(true);
    });

    taskNameFilter.addEventListener('input', () => renderTasks(getFilteredTasks()));
    taskModeFilter.addEventListener('change', () => renderTasks(getFilteredTasks()));
    taskStatusFilter.addEventListener('change', () => renderTasks(getFilteredTasks()));
    runsStatusFilter.addEventListener('change', () => renderRuns(getFilteredRuns()));
    runsTaskIdFilter.addEventListener('input', () => renderRuns(getFilteredRuns()));
    eventsKeyword.addEventListener('input', () => {
      renderTaskEvents();
      if (eventsSearchTimer) clearTimeout(eventsSearchTimer);
      eventsSearchTimer = setTimeout(() => {
        if (selectedTaskId != null) {
          loadTaskEventHistory(selectedTaskId).catch((e) => {
            taskEventLines = [`[${fmtDateTime(Date.now())}] 搜索事件失败: ${String(e)}`];
            renderTaskEvents();
          });
        }
      }, 250);
    });

    function connectWs() {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${protocol}://${location.host}/ws`);
      ws.onopen = () => {
        wsConnected = true;
        setSyncStatus('WebSocket 已连接');
      };
      ws.onmessage = async (ev) => {
        try {
          const payload = JSON.parse(ev.data);
          const taskId = Number(payload.task_id);
          const eventType = String(payload.event || '');
          let shouldRefreshOverview = false;
          if (Number.isFinite(taskId)) {
            if (eventType === 'task_started') {
              setTaskProgress(taskId, {
                progress_pct: 0,
                completed_bytes: 0,
                total_bytes: 0,
              });
              shouldRefreshOverview = true;
            } else if (eventType === 'task_planned') {
              setTaskProgress(taskId, {
                total_bytes: Number(payload.total_bytes || 0),
              });
              updateTaskRowDisplay(taskId);
            } else if (eventType === 'task_progress') {
              const totalBytes = Number(payload.total_bytes || 0);
              const completedBytes = Number(payload.completed_bytes || 0);
              const pct = Number.isFinite(Number(payload.progress_pct))
                ? Number(payload.progress_pct)
                : (totalBytes > 0 ? (completedBytes / totalBytes * 100) : 0);
              setTaskProgress(taskId, {
                progress_pct: pct,
                completed_bytes: completedBytes,
                total_bytes: totalBytes,
              });
              updateTaskRowDisplay(taskId);
            } else if (eventType === 'task_completed') {
              const isSuccess = String(payload.status || '') === 'success';
              setTaskProgress(taskId, {
                progress_pct: isSuccess ? 100 : clampProgress((taskProgressMap.get(taskId) || {}).progress_pct),
              });
              shouldRefreshOverview = true;
            }
          }
          if (selectedTaskId != null && Number(payload.task_id) === selectedTaskId) {
            appendTaskEvent(payload);
          }
          if (shouldRefreshOverview) {
            await Promise.all([
              refreshRuns(),
              refreshDashboard(),
              refreshTasks(),
            ]);
            scheduleTaskRender(10);
          }
        } catch (error) {
          displayError('WebSocket 消息解析失败', error);
        }
      };
      ws.onclose = () => {
        wsConnected = false;
        setSyncStatus('WebSocket 断开，已切换到轮询模式');
        setTimeout(connectWs, 1500);
      };
      ws.onerror = () => {
        setSyncStatus('WebSocket 错误，等待重连');
      };
    }

    async function boot() {
      if (!adminPassword) {
        setGuardStatus('当前未配置管理员安全密码，敏感配置查看与高危写操作已禁用。', true);
      }
      setSyncStatus('初始化中');
      await Promise.all([
        refreshRemotes(),
        refreshTasks(),
        refreshRuns(),
        refreshDashboard(),
      ]);
      updateTaskEventHint();
      connectWs();
      dashboardRefreshInterval = setInterval(() => {
        refreshDashboard().catch((err) => displayError('刷新仪表盘失败', err));
      }, 10000);
      runsRefreshInterval = setInterval(() => {
        if (wsConnected) return;
        refreshRuns().catch((err) => displayError('刷新审计日志失败', err));
      }, 8000);
      tasksRefreshInterval = setInterval(() => {
        if (wsConnected) return;
        refreshTasks().catch((err) => displayError('刷新任务列表失败', err));
      }, 8000);
    }
    boot().catch((e) => displayError('初始化失败', e));
  </script>
</body>
</html>
