<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowSync 管理后台</title>
  <style>
    :root {
      --bg: #eff3f8;
      --card: #ffffff;
      --text: #1b2430;
      --muted: #5f6b7b;
      --line: #d7dde6;
      --line-soft: #e8edf4;
      --brand: #1e66ff;
      --brand-strong: #1452d8;
      --danger: #c9302c;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "PingFang SC", "Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(30, 102, 255, 0.1), transparent 35%),
        radial-gradient(circle at 100% 100%, rgba(22, 163, 74, 0.07), transparent 30%),
        var(--bg);
      color: var(--text);
    }
    .app-shell {
      max-width: 1320px;
      margin: 0 auto;
      padding: 24px;
    }
    h1, h2, h3 { margin: 0; }
    .headline { margin-bottom: 18px; }
    .subtle { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.7);
    }
    .value { font-size: 22px; font-weight: 700; margin-top: 4px; }
    .section { margin-bottom: 18px; }
    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border: 0;
      background: var(--brand);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .15s ease;
      font-size: 14px;
    }
    .btn:hover { background: var(--brand-strong); }
    .btn.secondary { background: #4f5d75; }
    .btn.danger { background: var(--danger); }
    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--line-soft);
      border-radius: 10px;
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; min-width: 760px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--line-soft); font-size: 14px; }
    th { background: #f6f8fb; }
    .th-filter { position: relative; }
    .th-filter-head { display: inline-flex; align-items: center; gap: 6px; }
    .filter-trigger {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      border-radius: 999px;
      width: 20px;
      height: 20px;
      font-size: 12px;
      line-height: 18px;
      text-align: center;
      cursor: pointer;
      padding: 0;
    }
    .filter-popover {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9998;
      width: 180px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.15);
    }
    .filter-popover.open { display: block; }
    .filter-popover input, .filter-popover select { font-size: 13px; padding: 7px 8px; }
    input, select, textarea {
      padding: 9px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      width: 100%;
      font-size: 14px;
      background: #fff;
      color: var(--text);
    }
    textarea { font-family: ui-monospace, Menlo, monospace; font-size: 12px; }
    .row { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .task-form { display: grid; gap: 12px; }
    .form-block {
      border: 1px solid var(--line-soft);
      border-radius: 10px;
      padding: 12px;
      background: linear-gradient(180deg, #fbfdff 0%, #fff 100%);
    }
    .form-block h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #344256;
      font-weight: 700;
    }
    .check-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 6px 10px;
    }
    .check-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }
    .check-item input[type="checkbox"] { width: 16px; height: 16px; }
    .param-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .param-field {
      border: 1px solid var(--line-soft);
      border-radius: 8px;
      background: #fff;
      padding: 10px;
    }
    .param-field label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: #2b3a4f;
      margin-bottom: 8px;
    }
    .param-field .hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .log-box {
      background: #111827;
      color: #d7fbd6;
      padding: 12px;
      border-radius: 8px;
      height: 220px;
      overflow: auto;
      font-family: ui-monospace, Menlo, monospace;
      font-size: 12px;
    }
    .task-row { cursor: pointer; position: relative; }
    .task-row.active { background: #eef4ff; }
    .status-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .status-running { color: #0b5bd3; background: #e7f0ff; }
    .status-success { color: #0f7a3d; background: #e8f8ef; }
    .status-failed { color: #b42318; background: #ffecec; }
    .status-idle, .status-paused { color: #475467; background: #eef1f5; }
    .progress-wrap {
      min-width: 180px;
      max-width: 240px;
    }
    .progress-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e9eef7;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1e66ff 0%, #2f8bff 100%);
      transition: width .18s ease;
    }
    .progress-text {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .actions-cell { position: relative; }
    .action-trigger { min-width: 76px; }
    .action-menu {
      position: fixed;
      left: 0;
      top: 0;
      z-index: 30;
      display: none;
      min-width: 140px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 8px;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.16);
      padding: 6px;
    }
    .action-menu.open { display: block; }
    .action-menu button {
      width: 100%;
      border: 0;
      background: transparent;
      color: var(--text);
      text-align: left;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .action-menu button:hover { background: #edf3ff; }
    .action-menu button.danger { color: #b42318; }
    .action-menu hr {
      border: 0;
      border-top: 1px solid var(--line-soft);
      margin: 6px 0;
    }
    .action-menu-top { z-index: 9999; }
    .hidden { display: none; }
    .modal-backdrop.hidden { display: none; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(12, 18, 32, 0.45);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      animation: fadeIn .12s ease-out;
    }
    .modal {
      width: min(960px, 100%);
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      animation: popIn .12s ease-out;
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .modal-open { overflow: hidden; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="headline">
      <h1>FlowSync Web 管理后台</h1>
      <div class="subtle">任务管理、Remotes 配置与运行审计</div>
    </div>

    <div class="section">
      <h2 style="margin-bottom:12px;">仪表盘</h2>
      <div class="grid">
        <div class="card"><div>运行中任务</div><div class="value" id="runningTasks">0</div></div>
        <div class="card"><div>今日传输流量</div><div class="value" id="todayBytes">0 B</div></div>
        <div class="card"><div>今日执行次数</div><div class="value" id="todayRuns">0</div></div>
        <div class="card"><div>CPU / 内存</div><div class="value" id="systemUsage">0% / 0 B</div></div>
      </div>
    </div>

    <div class="section card">
      <div class="section-head">
        <h2>后端存储配置（Remotes）</h2>
        <button class="btn" id="openRemoteModalBtn" type="button">新建 / 编辑 Remote</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>名称</th><th>类型</th><th>配置</th><th>操作</th></tr>
          </thead>
          <tbody id="remotesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <div class="section-head">
        <h2>任务列表</h2>
        <button class="btn" id="openTaskModalBtn" type="button">创建任务</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>名称</th>
              <th class="th-filter">
                <span class="th-filter-head">模式 <button class="filter-trigger" type="button" onclick="toggleFilterPopover('taskModePopover', event)">▾</button></span>
                <div class="filter-popover" id="taskModePopover">
                  <select id="taskModeFilter">
                    <option value="">模式: 全部</option>
                    <option value="copy">copy</option>
                    <option value="sync">sync</option>
                    <option value="move">move</option>
                  </select>
                </div>
              </th>
              <th>源</th><th>目标</th><th>Cron</th><th>启用</th>
              <th class="th-filter">
                <span class="th-filter-head">状态 <button class="filter-trigger" type="button" onclick="toggleFilterPopover('taskStatusPopover', event)">▾</button></span>
                <div class="filter-popover" id="taskStatusPopover">
                  <select id="taskStatusFilter">
                    <option value="">状态: 全部</option>
                    <option value="running">running</option>
                    <option value="success">success</option>
                    <option value="failed">failed</option>
                    <option value="idle">idle</option>
                    <option value="paused">paused</option>
                  </select>
                </div>
              </th>
              <th>进度</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2 style="margin-bottom:8px;">任务实时事件</h2>
      <div class="subtle" id="taskEventHint">请先点击上方任务行查看该任务实时事件</div>
      <div style="margin:8px 0;">
        <input id="eventsKeyword" placeholder="搜索实时事件关键词（如文件名）" />
      </div>
      <div class="log-box" id="events"></div>
    </div>

    <div class="section">
      <div class="section-head">
        <h2>审计日志</h2>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Run ID</th>
              <th class="th-filter">
                <span class="th-filter-head">Task ID <button class="filter-trigger" type="button" onclick="toggleFilterPopover('runsTaskIdPopover', event)">▾</button></span>
                <div class="filter-popover" id="runsTaskIdPopover">
                  <input id="runsTaskIdFilter" placeholder="全部" />
                </div>
              </th>
              <th class="th-filter">
                <span class="th-filter-head">状态 <button class="filter-trigger" type="button" onclick="toggleFilterPopover('runsStatusPopover', event)">▾</button></span>
                <div class="filter-popover" id="runsStatusPopover">
                  <select id="runsStatusFilter">
                    <option value="">状态: 全部</option>
                    <option value="running">running</option>
                    <option value="success">success</option>
                    <option value="failed">failed</option>
                  </select>
                </div>
              </th>
              <th>触发方式</th><th>开始</th><th>结束</th><th>成功文件</th><th>失败文件</th><th>传输字节</th>
            </tr>
          </thead>
          <tbody id="runsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="action-menu action-menu-top" id="taskActionMenu" onclick="event.stopPropagation()">
    <button id="taskActionRun" type="button">立即运行</button>
    <button id="taskActionEdit" type="button">编辑</button>
    <button id="taskActionDuplicate" type="button">复制</button>
    <button id="taskActionToggle" type="button">暂停</button>
    <hr />
    <button class="danger" id="taskActionDelete" type="button">删除</button>
  </div>
  <div class="action-menu action-menu-top" id="remoteActionMenu" onclick="event.stopPropagation()">
    <button id="remoteActionEdit" type="button">编辑</button>
    <button id="remoteActionDuplicate" type="button">复制</button>
    <hr />
    <button class="danger" id="remoteActionDelete" type="button">删除</button>
  </div>

  <div id="remoteModalBackdrop" class="modal-backdrop hidden">
    <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="remoteModalTitle">
      <div class="modal-head">
        <h2 id="remoteModalTitle">配置 Remote</h2>
        <button class="btn secondary" id="closeRemoteModalBtn" type="button">关闭</button>
      </div>
      <form id="remoteForm">
        <div class="row">
          <input id="remoteName" placeholder="remote 名称（如 local / s3prod）" required />
          <select id="remoteType">
            <option value="fs">fs</option>
            <option value="s3">s3</option>
            <option value="sftp">sftp</option>
            <option value="ftp">ftp</option>
          </select>
        </div>
        <div class="row" style="margin-top:10px;">
          <textarea id="remoteConfigJson" rows="7" placeholder='config_json（JSON对象，不含type字段）
示例(fs): {"root": "/"}
示例(s3): {"bucket":"my-bucket","endpoint":"https://s3.us-east-1.amazonaws.com","region":"us-east-1","url_style":"path","root":""}' required></textarea>
        </div>
        <div style="margin-top:12px;">
          <button class="btn" type="submit">保存 Remote</button>
        </div>
      </form>
    </div>
  </div>

  <div id="taskModalBackdrop" class="modal-backdrop hidden">
    <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
      <div class="modal-head">
        <h2 id="taskModalTitle">创建任务</h2>
        <button class="btn secondary" id="closeTaskModalBtn" type="button">关闭</button>
      </div>
      <form id="taskForm" class="task-form">
        <input id="taskId" type="hidden" />
        <div class="form-block">
          <h3>基础信息</h3>
          <div class="row">
            <input id="name" placeholder="任务名称" required />
            <select id="mode">
              <option value="sync">sync</option>
              <option value="copy">copy</option>
              <option value="move">move</option>
            </select>
            <input id="cron" placeholder="Cron (可选，如 0 */10 * * * *)" />
          </div>
        </div>
        <div class="form-block">
          <h3>数据路径</h3>
          <div class="row">
            <input id="source" placeholder="source (如 local:/data/src)" required />
            <input id="destination" placeholder="destination (如 s3prod:bucket/prefix)" required />
          </div>
        </div>
        <div class="form-block">
          <h3>执行参数</h3>
          <div class="param-grid">
            <div class="param-field">
              <label for="transfers">并发传输数</label>
              <input id="transfers" type="number" min="1" value="4" placeholder="默认 4" />
              <div class="hint">同时执行文件传输的数量。值越大速度可能越快，但更占用带宽和 CPU。</div>
            </div>
            <div class="param-field">
              <label for="checkers">并发检查数</label>
              <input id="checkers" type="number" min="1" value="8" placeholder="默认 8" />
              <div class="hint">同时执行源/目标扫描与差异比对的数量。值越大前期扫描更快。</div>
            </div>
            <div class="param-field">
              <label for="bandwidth">带宽限制</label>
              <input id="bandwidth" placeholder="可选，如 100MB" />
              <div class="hint">为空表示不限速；设置后可降低对业务网络的影响。</div>
            </div>
            <div class="param-field">
              <label for="chunkSize">流式分块大小</label>
              <input id="chunkSize" placeholder="默认 8MB（如 8MB / 16MB / 32MB）" />
              <div class="hint">单文件按块读写与哈希，减小内存峰值。S3 场景建议从 8MB 起步。</div>
            </div>
          </div>
          <div class="check-row" style="margin-top:10px;">
            <label class="check-item"><input id="checksum" type="checkbox" /> checksum</label>
            <label class="check-item"><input id="ignoreExisting" type="checkbox" /> ignore-existing</label>
            <label class="check-item"><input id="dryRun" type="checkbox" /> dry-run</label>
            <label class="check-item"><input id="enabled" type="checkbox" checked /> 启用调度</label>
          </div>
        </div>
        <div>
          <button class="btn" type="submit">创建任务</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const byId = (id) => document.getElementById(id);
    const fmtBytes = (n) => {
      const units = ['B','KB','MB','GB','TB']; let i = 0; let x = Number(n || 0);
      while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
      return `${x.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    };
    const eventBox = byId('events');
    const taskEventHint = byId('taskEventHint');
    const remoteModalBackdrop = byId('remoteModalBackdrop');
    const taskModalBackdrop = byId('taskModalBackdrop');
    const taskModeFilter = byId('taskModeFilter');
    const taskStatusFilter = byId('taskStatusFilter');
    const runsTaskIdFilter = byId('runsTaskIdFilter');
    const runsStatusFilter = byId('runsStatusFilter');
    const eventsKeyword = byId('eventsKeyword');
    const taskActionMenu = byId('taskActionMenu');
    const remoteActionMenu = byId('remoteActionMenu');
    let selectedTaskId = null;
    let selectedTaskName = '';
    let activeActionTaskId = null;
    let activeActionRemoteName = null;
    let editingTaskId = null;
    let latestTasks = [];
    let latestRemotes = [];
    let latestRuns = [];
    const taskProgressMap = new Map();
    let loadingTaskEventsFor = null;
    let taskEventLines = [];
    let eventsSearchTimer = null;

    function closeAllFilterPopovers() {
      document.querySelectorAll('.filter-popover.open').forEach((el) => el.classList.remove('open'));
    }
    function toggleFilterPopover(popoverId, event) {
      event?.stopPropagation();
      const popover = byId(popoverId);
      if (!popover) return;
      const shouldOpen = !popover.classList.contains('open');
      closeAllFilterPopovers();
      if (!shouldOpen) return;
      popover.classList.add('open');
      const trigger = event?.currentTarget || event?.target;
      const rect = trigger?.getBoundingClientRect?.();
      if (!rect) return;
      const popoverWidth = popover.offsetWidth || 180;
      const popoverHeight = popover.offsetHeight || 120;
      let left = rect.left;
      let top = rect.bottom + 6;
      left = Math.max(8, Math.min(left, window.innerWidth - popoverWidth - 8));
      if (top + popoverHeight > window.innerHeight - 8) {
        top = Math.max(8, rect.top - popoverHeight - 6);
      }
      popover.style.left = `${left}px`;
      popover.style.top = `${top}px`;
    }
    function closeAllTaskActionMenus() {
      taskActionMenu.classList.remove('open');
      activeActionTaskId = null;
    }
    function closeAllRemoteActionMenus() {
      remoteActionMenu.classList.remove('open');
      activeActionRemoteName = null;
    }
    function toggleTaskActionMenu(taskId, event) {
      event?.stopPropagation();
      const task = latestTasks.find((t) => t.id === taskId);
      if (!task) return;
      const wasSameTaskOpen = taskActionMenu.classList.contains('open') && activeActionTaskId === taskId;
      closeAllTaskActionMenus();
      closeAllRemoteActionMenus();
      if (wasSameTaskOpen) return;
      activeActionTaskId = taskId;
      byId('taskActionToggle').textContent = task.enabled ? '暂停' : '恢复';
      taskActionMenu.classList.add('open');
      const trigger = event?.currentTarget || event?.target;
      const rect = trigger?.getBoundingClientRect?.();
      if (!rect) return;
      const menuWidth = taskActionMenu.offsetWidth || 150;
      const menuHeight = taskActionMenu.offsetHeight || 180;
      let left = rect.right - menuWidth;
      let top = rect.bottom + 6;
      left = Math.max(8, Math.min(left, window.innerWidth - menuWidth - 8));
      if (top + menuHeight > window.innerHeight - 8) {
        top = Math.max(8, rect.top - menuHeight - 6);
      }
      taskActionMenu.style.left = `${left}px`;
      taskActionMenu.style.top = `${top}px`;
    }
    function toggleRemoteActionMenu(name, event) {
      event?.stopPropagation();
      const remote = latestRemotes.find((r) => r.name === name);
      if (!remote) return;
      const wasSameRemoteOpen = remoteActionMenu.classList.contains('open') && activeActionRemoteName === name;
      closeAllRemoteActionMenus();
      closeAllTaskActionMenus();
      if (wasSameRemoteOpen) return;
      activeActionRemoteName = name;
      remoteActionMenu.classList.add('open');
      const trigger = event?.currentTarget || event?.target;
      const rect = trigger?.getBoundingClientRect?.();
      if (!rect) return;
      const menuWidth = remoteActionMenu.offsetWidth || 150;
      const menuHeight = remoteActionMenu.offsetHeight || 140;
      let left = rect.right - menuWidth;
      let top = rect.bottom + 6;
      left = Math.max(8, Math.min(left, window.innerWidth - menuWidth - 8));
      if (top + menuHeight > window.innerHeight - 8) {
        top = Math.max(8, rect.top - menuHeight - 6);
      }
      remoteActionMenu.style.left = `${left}px`;
      remoteActionMenu.style.top = `${top}px`;
    }

    async function api(path, init) {
      const res = await fetch(path, init);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `HTTP ${res.status}`);
      }
      if (res.status === 204) return null;
      return res.json();
    }

    function statusLabel(status, enabled) {
      if (!enabled) return 'paused';
      return status || 'idle';
    }

    function statusClass(status) {
      if (status === 'running') return 'status-running';
      if (status === 'success') return 'status-success';
      if (status === 'failed') return 'status-failed';
      if (status === 'paused') return 'status-paused';
      return 'status-idle';
    }

    function updateTaskEventHint() {
      if (selectedTaskId == null) {
        taskEventHint.textContent = '请先点击上方任务行查看该任务实时事件';
      } else {
        taskEventHint.textContent = `当前任务: #${selectedTaskId} ${selectedTaskName}`;
      }
    }

    function renderTaskEvents() {
      const keyword = (eventsKeyword.value || '').trim().toLowerCase();
      const lines = keyword
        ? taskEventLines.filter((line) => line.toLowerCase().includes(keyword))
        : taskEventLines;
      eventBox.textContent = lines.join('\n');
      if (lines.length > 0) eventBox.textContent += '\n';
      eventBox.scrollTop = eventBox.scrollHeight;
    }

    function appendTaskEvent(obj) {
      if (selectedTaskId == null) return;
      const line = `[${new Date().toLocaleTimeString()}] ${JSON.stringify(obj)}`;
      taskEventLines.push(line);
      renderTaskEvents();
    }

    async function loadTaskEventHistory(taskId) {
      loadingTaskEventsFor = taskId;
      const keyword = (eventsKeyword.value || '').trim();
      const query = keyword
        ? `/api/events?task_id=${taskId}&limit=2000&keyword=${encodeURIComponent(keyword)}`
        : `/api/events?task_id=${taskId}&limit=2000`;
      const events = await api(query);
      if (loadingTaskEventsFor !== taskId || selectedTaskId !== taskId) return;
      taskEventLines = [];
      for (const record of events) {
        const payload = record.payload || { event: record.event_type };
        const line = `[${new Date(record.created_at || Date.now()).toLocaleTimeString()}] ${JSON.stringify(payload)}`;
        taskEventLines.push(line);
      }
      renderTaskEvents();
    }

    function selectTask(id, name) {
      if (selectedTaskId !== id) {
        taskEventLines = [];
        renderTaskEvents();
      }
      selectedTaskId = id;
      selectedTaskName = name;
      updateTaskEventHint();
      document.querySelectorAll('#tasksBody tr').forEach((tr) => {
        tr.classList.toggle('active', Number(tr.dataset.taskId) === id);
      });
      loadTaskEventHistory(id).catch((e) => {
        taskEventLines = [`[${new Date().toLocaleTimeString()}] 加载历史事件失败: ${String(e)}`];
        renderTaskEvents();
      });
    }

    function getFilteredTasks() {
      const mode = taskModeFilter.value;
      const status = taskStatusFilter.value;
      return latestTasks.filter((t) => {
        const effectiveStatus = statusLabel(t.status, t.enabled);
        if (mode && t.mode !== mode) return false;
        if (status && effectiveStatus !== status) return false;
        return true;
      });
    }

    function renderTasks(tasks) {
      byId('tasksBody').innerHTML = tasks.map(t => `
        <tr class="task-row ${selectedTaskId === t.id ? 'active' : ''}" data-task-id="${t.id}" onclick='selectTask(${t.id}, ${JSON.stringify(t.name)})'>
          <td>${t.id}</td>
          <td>${t.name}</td>
          <td>${t.mode}</td>
          <td>${t.source}</td>
          <td>${t.destination}</td>
          <td>${t.cron_expr || ''}</td>
          <td>${t.enabled ? '是' : '否'}</td>
          <td><span class="status-pill ${statusClass(statusLabel(t.status, t.enabled))}">${statusLabel(t.status, t.enabled)}</span></td>
          <td>${renderTaskProgressCell(t)}</td>
          <td class="actions-cell">
            <button class="btn secondary action-trigger" onclick="toggleTaskActionMenu(${t.id}, event)">操作 ▾</button>
          </td>
        </tr>
      `).join('');
    }

    function clampProgress(pct) {
      const n = Number(pct);
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(100, n));
    }

    function setTaskProgress(taskId, patch) {
      const existing = taskProgressMap.get(taskId) || {};
      taskProgressMap.set(taskId, {
        ...existing,
        ...patch,
        updated_at: Date.now(),
      });
    }

    function getTaskProgressDisplay(task) {
      const effectiveStatus = statusLabel(task.status, task.enabled);
      const progress = taskProgressMap.get(task.id);
      if (effectiveStatus === 'paused') {
        return { pct: 0, text: '-' };
      }
      if (!progress) {
        if (effectiveStatus === 'running') return { pct: 0, text: '0.0%' };
        return { pct: 0, text: '-' };
      }
      const pct = clampProgress(progress.progress_pct);
      const completed = Number(progress.completed_bytes || 0);
      const total = Number(progress.total_bytes || 0);
      if (total > 0) {
        return { pct, text: `${pct.toFixed(1)}% (${fmtBytes(completed)} / ${fmtBytes(total)})` };
      }
      return { pct, text: `${pct.toFixed(1)}%` };
    }

    function renderTaskProgressCell(task) {
      const d = getTaskProgressDisplay(task);
      return `
        <div class="progress-wrap">
          <div class="progress-track"><div class="progress-fill" style="width:${d.pct.toFixed(1)}%"></div></div>
          <div class="progress-text">${d.text}</div>
        </div>
      `;
    }

    function renderRemotes(remotes) {
      byId('remotesBody').innerHTML = remotes.map(r => `
        <tr>
          <td>${r.name}</td>
          <td>${r.type}</td>
          <td><pre style="margin:0;white-space:pre-wrap;max-width:700px;">${JSON.stringify(r.config_json || {}, null, 2)}</pre></td>
          <td class="actions-cell">
            <button class="btn secondary action-trigger" onclick='toggleRemoteActionMenu(${JSON.stringify(r.name)}, event)'>操作 ▾</button>
          </td>
        </tr>
      `).join('');
    }

    function getFilteredRuns() {
      const taskIdRaw = runsTaskIdFilter.value.trim();
      const status = runsStatusFilter.value;
      return latestRuns.filter((r) => {
        if (taskIdRaw && String(r.task_id) !== taskIdRaw) return false;
        if (status && r.status !== status) return false;
        return true;
      });
    }

    function renderRuns(runs) {
      byId('runsBody').innerHTML = runs.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.task_id}</td>
          <td>${r.status}</td>
          <td>${r.trigger_type}</td>
          <td>${r.started_at}</td>
          <td>${r.ended_at || ''}</td>
          <td>${r.copied_files}</td>
          <td>${r.failed_files}</td>
          <td>${fmtBytes(r.copied_bytes)}</td>
        </tr>
      `).join('');
    }

    async function refreshTasks() {
      latestTasks = await api('/api/tasks');
      renderTasks(getFilteredTasks());
    }

    async function refreshRemotes() {
      latestRemotes = await api('/api/remotes');
      renderRemotes(latestRemotes);
    }

    async function refreshRuns() {
      latestRuns = await api('/api/runs?limit=200');
      renderRuns(getFilteredRuns());
    }

    async function refreshDashboard() {
      const d = await api('/api/dashboard');
      byId('runningTasks').textContent = d.running_tasks;
      byId('todayBytes').textContent = fmtBytes(d.today_transferred_bytes);
      byId('todayRuns').textContent = d.today_runs;
      byId('systemUsage').textContent = `${(d.cpu_usage_percent || 0).toFixed(1)}% / ${fmtBytes(d.memory_used_bytes)} / ${fmtBytes(d.memory_total_bytes)}`;
    }

    async function runTask(id) {
      await api(`/api/tasks/${id}/run`, { method: 'POST' });
      await refreshDashboard();
    }
    async function pauseTask(id) {
      await api(`/api/tasks/${id}/pause`, { method: 'POST' });
      await refreshTasks();
    }
    async function resumeTask(id) {
      await api(`/api/tasks/${id}/resume`, { method: 'POST' });
      await refreshTasks();
    }
    async function deleteTask(id) {
      if (!confirm(`确认删除任务 ${id} ?`)) return;
      await api(`/api/tasks/${id}`, { method: 'DELETE' });
      if (selectedTaskId === id) {
        selectedTaskId = null;
        selectedTaskName = '';
        taskEventLines = [];
        renderTaskEvents();
        updateTaskEventHint();
      }
      await refreshTasks();
      await refreshRuns();
    }
    async function deleteRemote(name) {
      if (!confirm(`确认删除 remote ${name} ?`)) return;
      await api(`/api/remotes/${encodeURIComponent(name)}`, { method: 'DELETE' });
      await refreshRemotes();
    }
    function openRemoteModal() {
      remoteModalBackdrop.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }
    function closeRemoteModal() {
      remoteModalBackdrop.classList.add('hidden');
      document.body.classList.remove('modal-open');
    }
    function openTaskModal() {
      taskModalBackdrop.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }
    function closeTaskModal() {
      taskModalBackdrop.classList.add('hidden');
      document.body.classList.remove('modal-open');
    }
    function fillRemoteForm(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      byId('remoteName').value = data.name;
      byId('remoteType').value = data.type;
      byId('remoteConfigJson').value = JSON.stringify(data.config_json || {}, null, 2);
      openRemoteModal();
    }
    function duplicateRemote(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      byId('remoteName').value = `${data.name}-copy`;
      byId('remoteType').value = data.type;
      byId('remoteConfigJson').value = JSON.stringify(data.config_json || {}, null, 2);
      openRemoteModal();
    }
    function fillTaskForm(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      editingTaskId = data.id;
      byId('taskId').value = String(data.id);
      byId('taskModalTitle').textContent = `编辑任务 #${data.id}`;
      byId('taskForm').querySelector('button[type="submit"]').textContent = '保存任务';
      byId('name').value = data.name || '';
      byId('source').value = data.source || '';
      byId('destination').value = data.destination || '';
      byId('mode').value = data.mode || 'sync';
      byId('cron').value = data.cron_expr || '';
      byId('enabled').checked = Boolean(data.enabled);
      byId('transfers').value = Number(data.transfers || 4);
      byId('checkers').value = Number(data.checkers || 8);
      byId('checksum').checked = Boolean(data.checksum);
      byId('ignoreExisting').checked = Boolean(data.ignore_existing);
      byId('dryRun').checked = Boolean(data.dry_run);
      byId('bandwidth').value = data.bandwidth_limit || '';
      byId('chunkSize').value = data.chunk_size || '8MB';
      openTaskModal();
    }
    function duplicateTask(payload) {
      const data = JSON.parse(decodeURIComponent(payload));
      resetTaskFormToCreateMode();
      byId('name').value = `${data.name}-copy`;
      byId('source').value = data.source || '';
      byId('destination').value = data.destination || '';
      byId('mode').value = data.mode || 'sync';
      byId('cron').value = data.cron_expr || '';
      byId('enabled').checked = Boolean(data.enabled);
      byId('transfers').value = Number(data.transfers || 4);
      byId('checkers').value = Number(data.checkers || 8);
      byId('checksum').checked = Boolean(data.checksum);
      byId('ignoreExisting').checked = Boolean(data.ignore_existing);
      byId('dryRun').checked = Boolean(data.dry_run);
      byId('bandwidth').value = data.bandwidth_limit || '';
      byId('chunkSize').value = data.chunk_size || '8MB';
      openTaskModal();
    }
    function resetTaskFormToCreateMode() {
      editingTaskId = null;
      byId('taskId').value = '';
      byId('taskModalTitle').textContent = '创建任务';
      byId('taskForm').querySelector('button[type="submit"]').textContent = '创建任务';
      byId('taskForm').reset();
      byId('transfers').value = 4;
      byId('checkers').value = 8;
      byId('chunkSize').value = '8MB';
      byId('enabled').checked = true;
    }
    window.runTask = runTask;
    window.pauseTask = pauseTask;
    window.resumeTask = resumeTask;
    window.deleteTask = deleteTask;
    window.fillTaskForm = fillTaskForm;
    window.duplicateTask = duplicateTask;
    window.selectTask = selectTask;
    window.deleteRemote = deleteRemote;
    window.fillRemoteForm = fillRemoteForm;
    window.duplicateRemote = duplicateRemote;
    window.openRemoteModal = openRemoteModal;
    window.closeRemoteModal = closeRemoteModal;
    window.openTaskModal = openTaskModal;
    window.closeTaskModal = closeTaskModal;
    window.toggleFilterPopover = toggleFilterPopover;
    window.toggleTaskActionMenu = toggleTaskActionMenu;
    window.closeAllTaskActionMenus = closeAllTaskActionMenus;
    window.toggleRemoteActionMenu = toggleRemoteActionMenu;
    window.closeAllRemoteActionMenus = closeAllRemoteActionMenus;

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.th-filter')) closeAllFilterPopovers();
      if (!e.target.closest('.actions-cell')) closeAllTaskActionMenus();
      if (!e.target.closest('.actions-cell')) closeAllRemoteActionMenus();
    });
    window.addEventListener('resize', () => {
      closeAllFilterPopovers();
      closeAllTaskActionMenus();
      closeAllRemoteActionMenus();
    });
    window.addEventListener('scroll', () => {
      closeAllFilterPopovers();
      closeAllTaskActionMenus();
      closeAllRemoteActionMenus();
    }, true);

    byId('openRemoteModalBtn').addEventListener('click', () => {
      byId('remoteForm').reset();
      openRemoteModal();
    });
    byId('taskActionRun').addEventListener('click', async () => {
      if (activeActionTaskId == null) return;
      const id = activeActionTaskId;
      closeAllTaskActionMenus();
      await runTask(id);
    });
    byId('taskActionEdit').addEventListener('click', () => {
      if (activeActionTaskId == null) return;
      const task = latestTasks.find((t) => t.id === activeActionTaskId);
      closeAllTaskActionMenus();
      if (!task) return;
      fillTaskForm(encodeURIComponent(JSON.stringify(task)));
    });
    byId('taskActionDuplicate').addEventListener('click', () => {
      if (activeActionTaskId == null) return;
      const task = latestTasks.find((t) => t.id === activeActionTaskId);
      closeAllTaskActionMenus();
      if (!task) return;
      duplicateTask(encodeURIComponent(JSON.stringify(task)));
    });
    byId('taskActionToggle').addEventListener('click', async () => {
      if (activeActionTaskId == null) return;
      const task = latestTasks.find((t) => t.id === activeActionTaskId);
      const id = activeActionTaskId;
      closeAllTaskActionMenus();
      if (!task) return;
      if (task.enabled) {
        await pauseTask(id);
      } else {
        await resumeTask(id);
      }
    });
    byId('taskActionDelete').addEventListener('click', async () => {
      if (activeActionTaskId == null) return;
      const id = activeActionTaskId;
      closeAllTaskActionMenus();
      await deleteTask(id);
    });
    byId('remoteActionEdit').addEventListener('click', () => {
      if (activeActionRemoteName == null) return;
      const remote = latestRemotes.find((r) => r.name === activeActionRemoteName);
      closeAllRemoteActionMenus();
      if (!remote) return;
      fillRemoteForm(encodeURIComponent(JSON.stringify({
        name: remote.name,
        type: remote.type,
        config_json: remote.config_json || {},
      })));
    });
    byId('remoteActionDuplicate').addEventListener('click', () => {
      if (activeActionRemoteName == null) return;
      const remote = latestRemotes.find((r) => r.name === activeActionRemoteName);
      closeAllRemoteActionMenus();
      if (!remote) return;
      duplicateRemote(encodeURIComponent(JSON.stringify({
        name: remote.name,
        type: remote.type,
        config_json: remote.config_json || {},
      })));
    });
    byId('remoteActionDelete').addEventListener('click', async () => {
      if (activeActionRemoteName == null) return;
      const name = activeActionRemoteName;
      closeAllRemoteActionMenus();
      await deleteRemote(name);
    });
    byId('closeRemoteModalBtn').addEventListener('click', closeRemoteModal);
    remoteModalBackdrop.addEventListener('click', (e) => {
      if (e.target === remoteModalBackdrop) closeRemoteModal();
    });
    byId('openTaskModalBtn').addEventListener('click', () => {
      resetTaskFormToCreateMode();
      openTaskModal();
    });
    byId('closeTaskModalBtn').addEventListener('click', () => {
      closeTaskModal();
      resetTaskFormToCreateMode();
    });
    taskModalBackdrop.addEventListener('click', (e) => {
      if (e.target === taskModalBackdrop) {
        closeTaskModal();
        resetTaskFormToCreateMode();
      }
    });

    byId('remoteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = byId('remoteName').value.trim();
      const type = byId('remoteType').value;
      let configJson = {};
      try {
        configJson = JSON.parse(byId('remoteConfigJson').value || '{}');
      } catch (err) {
        alert(`config_json 不是合法 JSON: ${err}`);
        return;
      }
      try {
        await api(`/api/remotes/${encodeURIComponent(name)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, config_json: configJson }),
        });
      } catch (_) {
        await api('/api/remotes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, type, config_json: configJson }),
        });
      }
      await refreshRemotes();
      byId('source').placeholder = `${name}:/path/from`;
      byId('destination').placeholder = `${name}:/path/to`;
      closeRemoteModal();
    });

    byId('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        name: byId('name').value,
        source: byId('source').value,
        destination: byId('destination').value,
        mode: byId('mode').value,
        cron_expr: byId('cron').value || null,
        enabled: byId('enabled').checked,
        transfers: Number(byId('transfers').value || 4),
        checkers: Number(byId('checkers').value || 8),
        checksum: byId('checksum').checked,
        ignore_existing: byId('ignoreExisting').checked,
        dry_run: byId('dryRun').checked,
        include: [],
        exclude: [],
        bandwidth_limit: byId('bandwidth').value || null,
        chunk_size: byId('chunkSize').value || '8MB'
      };
      if (editingTaskId) {
        await api(`/api/tasks/${editingTaskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        await api('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      resetTaskFormToCreateMode();
      closeTaskModal();
      await refreshTasks();
      await refreshRuns();
    });

    taskModeFilter.addEventListener('change', () => renderTasks(getFilteredTasks()));
    taskStatusFilter.addEventListener('change', () => renderTasks(getFilteredTasks()));
    runsStatusFilter.addEventListener('change', () => renderRuns(getFilteredRuns()));
    runsTaskIdFilter.addEventListener('input', () => renderRuns(getFilteredRuns()));
    eventsKeyword.addEventListener('input', () => {
      renderTaskEvents();
      if (eventsSearchTimer) clearTimeout(eventsSearchTimer);
      eventsSearchTimer = setTimeout(() => {
        if (selectedTaskId != null) {
          loadTaskEventHistory(selectedTaskId).catch((e) => {
            taskEventLines = [`[${new Date().toLocaleTimeString()}] 搜索事件失败: ${String(e)}`];
            renderTaskEvents();
          });
        }
      }, 250);
    });

    function connectWs() {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${protocol}://${location.host}/ws`);
      ws.onmessage = async (ev) => {
        try {
          const payload = JSON.parse(ev.data);
          const taskId = Number(payload.task_id);
          if (Number.isFinite(taskId)) {
            if (payload.event === 'task_started') {
              setTaskProgress(taskId, {
                progress_pct: 0,
                completed_bytes: 0,
                total_bytes: 0,
              });
            } else if (payload.event === 'task_planned') {
              setTaskProgress(taskId, {
                total_bytes: Number(payload.total_bytes || 0),
              });
            } else if (payload.event === 'task_progress') {
              const totalBytes = Number(payload.total_bytes || 0);
              const completedBytes = Number(payload.completed_bytes || 0);
              const pct = Number.isFinite(Number(payload.progress_pct))
                ? Number(payload.progress_pct)
                : (totalBytes > 0 ? (completedBytes / totalBytes * 100) : 0);
              setTaskProgress(taskId, {
                progress_pct: pct,
                completed_bytes: completedBytes,
                total_bytes: totalBytes,
              });
            } else if (payload.event === 'task_completed') {
              const isSuccess = String(payload.status || '') === 'success';
              setTaskProgress(taskId, {
                progress_pct: isSuccess ? 100 : clampProgress((taskProgressMap.get(taskId) || {}).progress_pct),
              });
            }
          }
          if (selectedTaskId != null && Number(payload.task_id) === selectedTaskId) {
            appendTaskEvent(payload);
          }
          renderTasks(getFilteredTasks());
          if (payload.event === 'task_completed' || payload.event === 'task_started') {
            await refreshRuns();
            await refreshDashboard();
            await refreshTasks();
          }
        } catch (error) {
          console.error('ws message parse failed', error, ev.data);
        }
      };
      ws.onclose = () => setTimeout(connectWs, 1500);
    }

    async function boot() {
      await refreshRemotes();
      await refreshTasks();
      await refreshRuns();
      await refreshDashboard();
      updateTaskEventHint();
      connectWs();
      setInterval(refreshDashboard, 5000);
      setInterval(refreshRuns, 8000);
      setInterval(refreshTasks, 8000);
    }
    boot().catch((e) => console.error(e));
  </script>
</body>
</html>
